<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COSVOTE - Secure Contest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #e2e8f0; overflow-x: hidden; }
        .glass-card { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(51, 65, 85, 0.5); }
        .upload-zone { border: 2px dashed rgba(51, 65, 85, 0.3); transition: all 0.3s ease; cursor: pointer; position: relative; overflow: hidden; height: 120px; border-radius: 1rem; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .upload-zone.has-file { border-color: #10b981; background: rgba(16, 185, 129, 0.05); border-style: solid; }
        .preview-img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        .loader { width: 18px; height: 18px; border: 2px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="selection:bg-indigo-500/30">

    <div id="root">
        <nav class="bg-slate-900/80 backdrop-blur-md border-b border-slate-800 sticky top-0 z-50 px-6 py-4">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center gap-2 cursor-pointer" onclick="app.setView('gallery')">
                    <div class="bg-indigo-600 p-2 rounded-lg shadow-lg">
                        <i data-lucide="camera" class="text-white w-6 h-6"></i>
                    </div>
                    <span class="text-xl font-bold bg-gradient-to-r from-white to-slate-400 bg-clip-text text-transparent">COSVOTE</span>
                </div>
                <div class="flex gap-4 sm:gap-6 items-center">
                    <button onclick="app.setView('gallery')" id="nav-gallery" class="text-sm font-medium transition-colors">Gallery</button>
                    <button onclick="app.setView('upload')" id="nav-upload" class="text-sm font-medium text-slate-400 hover:text-white transition-colors">Enter</button>
                    <button onclick="app.setView('admin')" id="nav-admin" class="px-4 py-2 rounded-full text-xs font-bold transition-all bg-slate-800 text-slate-300">Admin</button>
                </div>
            </div>
        </nav>

        <main id="main-content" class="pb-24 min-h-screen"></main>

        <div id="notification" class="fixed bottom-24 right-6 px-6 py-4 rounded-2xl shadow-2xl z-[100] flex items-center gap-3 border opacity-0 pointer-events-none transition-all duration-300 transform translate-y-4"></div>

        <footer class="fixed bottom-0 w-full bg-slate-900/90 backdrop-blur-md border-t border-slate-800 py-4 px-6 text-center z-40">
            <p class="text-[10px] text-slate-500 uppercase tracking-widest flex items-center justify-center gap-3">
                <span id="sync-status" class="flex items-center gap-1.5">
                    <span id="status-dot" class="w-2 h-2 rounded-full bg-slate-600"></span>
                    <span>Connecting...</span>
                </span>
                <span class="text-slate-700">|</span>
                <span>One Vote Per Device Policy Active</span>
            </p>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, onSnapshot, addDoc, deleteDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const githubConfig = {
            apiKey: "AIzaSyCVs3azcvXUt5TbHbCLNZsU3AHiVW4nwtk",
            authDomain: "cosplay-f8f1e.firebaseapp.com",
            projectId: "cosplay-f8f1e",
            storageBucket: "cosplay-f8f1e.firebasestorage.app",
            messagingSenderId: "86635858213",
            appId: "1:86635858213:web:eae6f15a09bb066a7032cc"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'cosplay-vote-production';
        const firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config) ? JSON.parse(__firebase_config) : githubConfig;

        class CosplayApp {
            constructor() {
                this.view = 'gallery';
                this.entries = [];
                this.votedIds = [];
                this.user = null;
                this.isAdmin = false;
                this.isBusy = false;
                this.db = null;
                this.auth = null;
                this.init();
            }

            async init() {
                try {
                    const app = initializeApp(firebaseConfig);
                    this.auth = getAuth(app);
                    this.db = getFirestore(app);

                    // Strict Auth-First Flow
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(this.auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(this.auth);
                    }

                    onAuthStateChanged(this.auth, (user) => {
                        this.user = user;
                        if (user) {
                            this.updateStatus("System Live", "emerald");
                            this.setupListeners();
                        } else {
                            this.updateStatus("Auth Error", "rose");
                        }
                    });
                } catch (e) {
                    this.updateStatus("Connection Lost", "rose");
                    this.showNotification("Network unstable. Please refresh.", "error");
                }
            }

            updateStatus(text, color) {
                const dot = document.getElementById('status-dot');
                const statusText = document.querySelector('#sync-status span:last-child');
                if (dot && statusText) {
                    dot.className = `w-2 h-2 rounded-full bg-${color}-500 ${color === 'emerald' ? 'animate-pulse' : ''}`;
                    statusText.textContent = text;
                    statusText.className = `text-${color}-500 font-bold`;
                }
            }

            setupListeners() {
                if (!this.user) return;

                // Sync Gallery
                const entriesRef = collection(this.db, 'artifacts', appId, 'public', 'data', 'entries');
                onSnapshot(entriesRef, (snap) => {
                    this.entries = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    this.entries.sort((a, b) => (b.votes || 0) - (a.votes || 0));
                    this.render();
                }, (err) => this.showNotification("Sync error", "error"));

                // Sync Private User Votes (Strict Check)
                const votesRef = doc(this.db, 'artifacts', appId, 'users', this.user.uid, 'votes', 'history');
                onSnapshot(votesRef, (snap) => {
                    this.votedIds = snap.exists() ? (snap.data().votedIds || []) : [];
                    this.render();
                });
            }

            async compressImage(file, maxDimension = 600) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (e) => {
                        const img = new Image();
                        img.src = e.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let w = img.width;
                            let h = img.height;
                            if (w > h) {
                                if (w > maxDimension) { h *= maxDimension / w; w = maxDimension; }
                            } else {
                                if (h > maxDimension) { w *= maxDimension / h; h = maxDimension; }
                            }
                            canvas.width = w;
                            canvas.height = h;
                            const ctx = canvas.getContext('2d');
                            ctx.fillStyle = "#FFFFFF";
                            ctx.fillRect(0, 0, w, h);
                            ctx.drawImage(img, 0, 0, w, h);
                            resolve(canvas.toDataURL('image/jpeg', 0.6));
                        };
                    };
                });
            }

            async submitEntry(e) {
                e.preventDefault();
                if (this.isBusy) return;
                
                const name = document.getElementById('form-name').value;
                const char = document.getElementById('form-char').value;
                const refFile = document.getElementById('ref-file').files[0];
                const cosFile = document.getElementById('cos-file').files[0];

                if (!name || !char || !refFile || !cosFile) {
                    return this.showNotification("Please select both photos", "error");
                }

                this.isBusy = true;
                this.render();

                try {
                    const refBase64 = await this.compressImage(refFile);
                    const cosBase64 = await this.compressImage(cosFile);

                    const entriesRef = collection(this.db, 'artifacts', appId, 'public', 'data', 'entries');
                    await addDoc(entriesRef, {
                        cosplayer: name,
                        character: char,
                        refImg: refBase64,
                        cosplayImg: cosBase64,
                        votes: 0,
                        userId: this.user.uid,
                        createdAt: Date.now()
                    });

                    this.showNotification("Entry Published!");
                    this.setView('gallery');
                } catch (err) {
                    this.showNotification("Upload failed. Try a smaller photo.", "error");
                } finally {
                    this.isBusy = false;
                    this.render();
                }
            }

            async handleVote(entryId) {
                if (this.votedIds.includes(entryId) || this.isBusy || !this.user) return;
                
                this.isBusy = true;
                this.render();

                try {
                    // Update entry count
                    const entryRef = doc(this.db, 'artifacts', appId, 'public', 'data', 'entries', entryId);
                    await updateDoc(entryRef, { votes: increment(1) });

                    // Record vote for this specific device/user
                    const userVotesRef = doc(this.db, 'artifacts', appId, 'users', this.user.uid, 'votes', 'history');
                    const updatedVotes = [...this.votedIds, entryId];
                    await setDoc(userVotesRef, { votedIds: updatedVotes }, { merge: true });

                    this.showNotification("Vote Registered!");
                } catch (e) {
                    this.showNotification("Voting failed. Try again.", "error");
                } finally {
                    this.isBusy = false;
                }
            }

            showNotification(msg, type = 'success') {
                const toast = document.getElementById('notification');
                toast.innerHTML = `<i data-lucide="${type === 'success' ? 'check-circle' : 'alert-circle'}" class="w-5 h-5"></i><span>${msg}</span>`;
                toast.className = `fixed bottom-24 right-6 px-6 py-4 rounded-2xl shadow-2xl z-[100] flex items-center gap-3 border transition-all duration-300 opacity-100 translate-y-0 ${
                    type === 'success' ? 'bg-emerald-900/95 border-emerald-500 text-emerald-100' : 'bg-rose-900/95 border-rose-500 text-rose-100'
                }`;
                lucide.createIcons();
                setTimeout(() => toast.classList.add('opacity-0', 'translate-y-4'), 3000);
            }

            setView(v) { this.view = v; this.render(); window.scrollTo(0,0); }

            async handleFileSelect(id, zoneId) {
                const file = document.getElementById(id).files[0];
                const zone = document.getElementById(zoneId);
                if (file) {
                    const preview = await this.compressImage(file, 300);
                    zone.classList.add('has-file');
                    zone.innerHTML = `<img src="${preview}" class="preview-img"><div class="absolute inset-0 bg-black/40 flex items-center justify-center"><i data-lucide="check" class="text-white"></i></div>`;
                    lucide.createIcons();
                }
            }

            render() {
                const main = document.getElementById('main-content');
                if (!main) return;

                if (this.view === 'gallery') {
                    main.innerHTML = `
                        <div class="max-w-4xl mx-auto p-6 animate-fade-in">
                            <div class="text-center mb-10">
                                <h2 class="text-3xl font-black text-white">The Arena</h2>
                                <p class="text-slate-500 text-sm">Strictly 1 vote per device</p>
                            </div>
                            <div class="grid grid-cols-1 gap-8">
                                ${this.entries.length === 0 ? '<p class="text-center text-slate-700 py-20">Waiting for entries...</p>' : this.entries.map(e => `
                                    <div class="glass-card rounded-[2rem] overflow-hidden flex flex-col">
                                        <div class="p-5 flex justify-between items-center border-b border-white/5">
                                            <div>
                                                <h3 class="font-bold text-white text-lg">${e.cosplayer}</h3>
                                                <p class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">${e.character}</p>
                                            </div>
                                            <div class="bg-indigo-500/20 text-indigo-400 px-4 py-1.5 rounded-full text-xs font-black border border-indigo-500/30">
                                                ${e.votes || 0} VOTES
                                            </div>
                                        </div>
                                        <div class="flex h-72 sm:h-96 relative bg-black">
                                            <div class="w-1/2 relative border-r border-white/5">
                                                <img src="${e.refImg}" class="w-full h-full object-cover opacity-60">
                                                <div class="absolute bottom-3 left-3 bg-black/60 px-2 py-1 rounded text-[9px] font-bold text-white">REF</div>
                                            </div>
                                            <div class="w-1/2 relative">
                                                <img src="${e.cosplayImg}" class="w-full h-full object-cover">
                                                <div class="absolute bottom-3 right-3 bg-indigo-600 px-2 py-1 rounded text-[9px] font-bold text-white uppercase tracking-tighter">Cosplay</div>
                                            </div>
                                        </div>
                                        <div class="p-5">
                                            <button 
                                                onclick="app.handleVote('${e.id}')" 
                                                ${this.votedIds.includes(e.id) ? 'disabled' : ''}
                                                class="w-full py-4 rounded-2xl font-black tracking-widest transition-all ${this.votedIds.includes(e.id) ? 'bg-slate-800 text-slate-600' : 'bg-indigo-600 text-white shadow-xl shadow-indigo-600/20 active:scale-95'}">
                                                ${this.votedIds.includes(e.id) ? 'VOTE RECORDED' : 'VOTE FOR THIS'}
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>`;
                } else if (this.view === 'upload') {
                    main.innerHTML = `
                        <div class="max-w-xl mx-auto p-6 mt-6 animate-fade-in">
                            <div class="glass-card p-8 rounded-[2.5rem] shadow-2xl">
                                <h2 class="text-2xl font-bold text-white mb-2 text-center">Entry Form</h2>
                                <p class="text-slate-500 text-xs text-center mb-8 italic">Device ID tracked for fairness</p>
                                <form onsubmit="app.submitEntry(event)" class="space-y-6">
                                    <div class="space-y-4">
                                        <input id="form-name" type="text" placeholder="Your Alias" required class="w-full bg-slate-900/50 border border-slate-800 rounded-xl px-4 py-4 text-white outline-none focus:border-indigo-500 transition-all">
                                        <input id="form-char" type="text" placeholder="Character Name" required class="w-full bg-slate-900/50 border border-slate-800 rounded-xl px-4 py-4 text-white outline-none focus:border-indigo-500 transition-all">
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div id="ref-zone" class="upload-zone" onclick="document.getElementById('ref-file').click()">
                                            <input type="file" id="ref-file" accept="image/*" class="hidden" onchange="app.handleFileSelect('ref-file', 'ref-zone')">
                                            <i data-lucide="image" class="text-slate-700 w-8 h-8 mb-2"></i>
                                            <span class="text-[9px] font-bold text-slate-600">REF PHOTO</span>
                                        </div>
                                        <div id="cos-zone" class="upload-zone" onclick="document.getElementById('cos-file').click()">
                                            <input type="file" id="cos-file" accept="image/*" class="hidden" onchange="app.handleFileSelect('cos-file', 'cos-zone')">
                                            <i data-lucide="camera" class="text-slate-700 w-8 h-8 mb-2"></i>
                                            <span class="text-[9px] font-bold text-slate-600">COSPLAY</span>
                                        </div>
                                    </div>
                                    <button type="submit" ${this.isBusy ? 'disabled' : ''} class="w-full bg-indigo-600 py-4 rounded-2xl text-white font-black shadow-xl shadow-indigo-600/30 hover:bg-indigo-500 flex justify-center items-center gap-2">
                                        ${this.isBusy ? '<span class="loader"></span> PROCESSING...' : 'JOIN CONTEST'}
                                    </button>
                                </form>
                            </div>
                        </div>`;
                } else if (this.view === 'admin') {
                    if (!this.isAdmin) {
                        main.innerHTML = `
                            <div class="max-w-md mx-auto mt-20 p-8 glass-card rounded-[2.5rem] text-center animate-fade-in">
                                <i data-lucide="lock" class="mx-auto w-10 h-10 text-indigo-500 mb-6"></i>
                                <h3 class="text-xl font-bold text-white mb-6">Admin Key Required</h3>
                                <input id="admin-key" type="password" placeholder="Passcode" class="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-4 text-white mb-6 text-center outline-none">
                                <button onclick="app.authAdmin()" class="w-full bg-indigo-600 py-4 rounded-xl font-bold">Access Registry</button>
                            </div>`;
                    } else {
                        main.innerHTML = `
                            <div class="max-w-4xl mx-auto p-6 animate-fade-in">
                                <div class="flex justify-between items-center mb-8">
                                    <h2 class="text-2xl font-bold text-white">Registry Management</h2>
                                    <button onclick="app.isAdmin=false; app.render();" class="text-xs font-bold text-rose-500">Lock Terminal</button>
                                </div>
                                <div class="glass-card rounded-[2rem] overflow-hidden">
                                    ${this.entries.map(e => `
                                        <div class="p-4 flex items-center justify-between border-b border-white/5">
                                            <div><p class="font-bold text-sm text-white">${e.cosplayer}</p><p class="text-[10px] text-slate-500 uppercase">${e.character}</p></div>
                                            <div class="flex items-center gap-4">
                                                <span class="text-xs font-bold text-indigo-400 font-mono">${e.votes || 0}V</span>
                                                <button onclick="app.deleteEntry('${e.id}')" class="text-slate-700 hover:text-rose-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>`;
                    }
                }
                lucide.createIcons();
            }

            authAdmin() {
                if (document.getElementById('admin-key').value === 'cosplay123') {
                    this.isAdmin = true;
                    this.showNotification("Access Granted");
                    this.render();
                } else {
                    this.showNotification("Invalid Key", "error");
                }
            }

            async deleteEntry(id) {
                if (!confirm("Delete this?")) return;
                try {
                    await deleteDoc(doc(this.db, 'artifacts', appId, 'public', 'data', 'entries', id));
                    this.showNotification("Entry Deleted");
                } catch (e) { this.showNotification("Delete error", "error"); }
            }
        }

        window.app = new CosplayApp();
    </script>
</body>
</html>
